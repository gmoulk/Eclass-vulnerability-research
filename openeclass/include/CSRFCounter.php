<?php 

function hash_equals($str1, $str2){
        if(strlen($str1) != strlen($str2))
        {
            return false;
        }
        else
        {
            $res = $str1 ^ $str2;
            $ret = 0;
            for($i = strlen($res) - 1; $i >= 0; $i--)
            {
                $ret |= ord($res[$i]);
            }
            return !$ret;
        }
    }

function generateToken(){
    if(empty($_SESSION['CSRF'])){
        $_SESSION['CSRF'] = bin2hex(openssl_random_pseudo_bytes(32));
    }
    $token = $_SESSION['CSRF'];
    return $token;
}

function validateToken(){
    $result = true;
    if(!isset($_SESSION['CSRF'])){
        $result = false;
    }

    $post_result = $_POST['CSRF_LABEL'];
    if(!empty($post_result) && $result == true){
        $token = $_POST['CSRF_LABEL'];
    }
    else{
        $result = false;
    }

    if(is_string($token) && $result){
        $result = false;
    }
    $expTKN = $_SESSION['CSRF'];
    $result = hash_equals($token,$expTKN);
    if(!$result){
        echo '<p>NOT THIS FAST!</p>';
    }
    return $result;
}

function validateTokenFromGet(){
    $result = true;
    if(!isset($_SESSION['CSRF'])){
        $result = false;
    }

    $post_result = $_GET['token'];
    if(!empty($post_result) && $result == true){
        $token = $_GET['token'];
    }
    else{
        $result = false;
    }

    if(is_string($token) && $result){
        $result = false;
    }
    $expTKN = $_SESSION['CSRF'];
    $result = hash_equals($token,$expTKN);
    if(!$result){
        echo '<p>NOT THIS FAST!</p>';
    }
    return $result;
}

// Paste this in inputs of form
//     <input type=\"hidden\" name=\"CSRF_LABEL\" value=\"$token\">  